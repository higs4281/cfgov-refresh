<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: organisms/FilterableListControls.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: organisms/FilterableListControls.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

// Required modules.
var Analytics = require( '../modules/Analytics' );
var atomicHelpers = require( '../modules/util/atomic-helpers' );
var ERROR_MESSAGES = require( '../config/error-messages-config' );
var Expandable = require( '../organisms/Expandable' );
var getClosestElement = require( '../modules/util/dom-traverse' ).closest;
var Multiselect = require( '../molecules/Multiselect' );
var Notification = require( '../molecules/Notification' );
var standardType = require( '../modules/util/standard-type' );
var validators = require( '../modules/util/validators' );


/**
 * FilterableListControls
 * @class
 *
 * @classdesc Initializes a new Filterable-List-Controls organism.
 *
 * @param {HTMLNode} element
 *   The DOM element within which to search for the organism.
 * @returns {FilterableListControls} An instance.
 */
function FilterableListControls( element ) {
  var BASE_CLASS = 'o-filterable-list-controls';
  var _dom = atomicHelpers.checkDom( element, BASE_CLASS );
  var _expandable;
  var _form = _dom.querySelector( 'form' );
  var _notification;
  var _fieldGroups;

  var _defaults = {
    ignoreFieldTypes: [
      'hidden',
      'button',
      'submit',
      'reset',
      'fieldset'
    ],
    groupFieldTypes: [
      'radio',
      'checkbox'
    ]
  };

  var _cachedLabels = {};

  /**
   * @returns {FilterableListControls|undefined} An instance,
   *   or undefined if it was already initialized.
   */
  function init() {
    if ( !atomicHelpers.setInitFlag( _dom ) ) {
      return standardType.UNDEFINED;
    }

    // instantiate multiselects before their containing expandable
    // so height of any 'selected choice' buttons is included when
    // expandable height is calculated initially
    atomicHelpers.instantiateAll( 'select[multiple]', Multiselect );

    // TODO: FilterableListControls should use expandable
    //       behavior (FlyoutMenu), not an expandable directly.
    _expandable = new Expandable( _dom );
    _expandable.init();

    _notification = new Notification( _dom );
    _notification.init();

    _initEvents();

    return this;
  }

  /**
   * Initialize FilterableListControls events.
   */
  function _initEvents() {
    var labelDom = _dom.querySelector( '.o-expandable_label' );
    var label;

    if ( labelDom ) {
      label = labelDom.textContent.trim();
    }

    _expandable.addEventListener( 'expandBegin',
    function sendEvent( ) {
      Analytics.sendEvent( 'Filter:open', label );
    } );

    _expandable.addEventListener( 'collapseBegin',
    function sendEvent( ) {
      Analytics.sendEvent( 'Filter:close', label );
    } );

    _form.addEventListener( 'change', function sendEvent( event ) {
      var action;
      var field = event.target;
      var fieldValue;
      var fieldLabel;

      if ( !field ) {
        return;
      }

      if ( !_cachedLabels[field.name] ) {
        _cachedLabels[field.name] = {
          label: _getLabelText( field )
        };
      }

      if ( field.type === 'checkbox' &amp;&amp; field.checked === false ) {
        fieldValue = 'null';
      } else {
        fieldValue = field.value;
      }

      fieldLabel = _cachedLabels[field.name].label + ':' + fieldValue;
      action = 'Filter:' + field.type + ':changed';
      Analytics.sendEvent( action, fieldLabel );
    } );

    _form.addEventListener( 'submit', function sendEvent( event ) {
      event.preventDefault();
      Analytics.sendEvent( 'Filter:submit', label, _formSubmitted );
    } );
  }

  /**
   * Remove Event listeners.
   */
  function destroy() {
    _form.removeEventListener( 'submit', _formSubmitted );
  }

  /**
   * Handle form sumbmission and showing error notification.
   */
  function _formSubmitted( ) {
    var validatedFields = _validateFields( [].slice.call( _form.elements ) );

    if ( validatedFields.invalid.length > 0 ) {
      _setNotification( _notification.ERROR,
                        _buildErrorMessage( validatedFields.invalid ) );
    } else {
      _form.submit();
    }
  }

  /**
   * Build the error message to display within the notification.
   * @param {Array} fields A list of form fields.
   * @returns {string} A text to use for the error notification.
   */
  function _buildErrorMessage( fields ) {
    var msg = '';
    fields.forEach( function( validation ) {
      msg += validation.label + ' ' + validation.msg + '&lt;/br>';
    } );

    return msg || ERROR_MESSAGES.DEFAULT;
  }

  /**
   * Validate the fields of our form.
   * @param {HTMLNode} field A form field.
   * @param {string} selector Selector used to retreive the dom element.
   * @param {boolean} isInGroup Flag used determine if field is in group.
   * @returns {string} The label of the field.
   */
  function _getLabelText( field, selector, isInGroup ) {
    var labelText = '';
    var labelDom;

    if ( isInGroup &amp;&amp; !selector ) {
      labelDom = getClosestElement( field, 'fieldset' );
      if ( labelDom ) labelDom = labelDom.querySelector( 'legend' );
    } else {
      selector = selector ||
                 'label[for="' + field.getAttribute( 'id' ) + '"]';
      labelDom = _form.querySelector( selector );
    }

    if ( labelDom ) labelText = labelDom.textContent.trim();

    return labelText;
  }

  /**
   * Set the notification type, msg, and visibility.
   * @param {string} type The type of notification to display.
   * @param {string} msg The message to display in the notification.
   * @param {string} methodName The method to use to control visibility
   *                            of the notification.
   */
  function _setNotification( type, msg, methodName ) {
    methodName = methodName || 'show';
    _notification.setTypeAndContent( type, msg );
    _notification[methodName]();
  }

  /**
   * Determines if you should validate a field.
   * @param {HTMLNode} field A form field.
   * @param {string} type The type of field.
   * @param {boolean} isInGroup A boolean that determines if field in a group.
   * @returns {boolean} True if the field should be validated, false otherwise.
   */
  function shouldValidateField( field, type, isInGroup ) {
    var isDisabled = field.getAttribute( 'disabled' ) !== null;
    var isIgnoreType = _defaults.ignoreFieldTypes.indexOf( type ) > -1;
    var shouldValidate = isDisabled === false &amp;&amp; isIgnoreType === false;

    if ( shouldValidate &amp;&amp; isInGroup ) {
      var name = field.getAttribute( 'data-group' ) ||
                 field.getAttribute( 'name' );
      var isRequired = field.getAttribute( 'data-required' ) !== null;
      var groupExists = _fieldGroups.indexOf( name ) > -1;
      if ( groupExists || isRequired === false ) {
        shouldValidate = false;
      } else {
        _fieldGroups.push( name );
      }
    }

    return shouldValidate;
  }

  /**
   * Validate the fields of our form.
   * @param {Array} fields A list of form fields.
   * @returns {Object}
   *   The tested list of fields broken into valid and invalid blocks.
   */
  function _validateFields( fields ) {
    var validatedFields = {
      invalid: [],
      valid:   []
    };
    var validatedField;

    _fieldGroups = [];

    fields.forEach( function loopFields( field ) {
      var fieldIsValid = true;
      var type = field.getAttribute( 'data-type' ) ||
                 field.getAttribute( 'type' ) ||
                 field.tagName.toLowerCase();
      var isGroupField = _defaults.groupFieldTypes.indexOf( type ) > -1;

      if ( shouldValidateField( field, type, isGroupField ) === false ) return;

      validatedField = _validateField( field, type, isGroupField );

      for ( var prop in validatedField.status ) {
        if ( validatedField.status[prop] === false ) fieldIsValid = false;
      }

      if ( fieldIsValid ) {
        validatedFields.valid.push( validatedField );
      } else {
        validatedFields.invalid.push( validatedField );
      }
    } );

    return validatedFields;
  }

  /**
   * Validate the specific field types.
   * @param {HTMLNode} field A form field.
   * @param {string} type The type of field.
   * @param {boolean} isInGroup A boolean that determines if field in a group.
   * @returns {Object} An object with a status and message properties.
   */
  function _validateField( field, type, isInGroup ) {
    var fieldset;
    var validation = {
      field:      field,
      // TODO: Change layout of field groups to use fieldset.
      label:      _getLabelText( field, '', false || isInGroup ),
      msg:        '',
      status:     null
    };

    if ( isInGroup ) {
      var groupName = field.getAttribute( 'data-group' ) ||
                      field.getAttribute( 'name' );
      var groupSelector = '[name=' + groupName + ']:checked,' +
                          '[data-group=' + groupName + ']:checked';
      fieldset = _form.querySelectorAll( groupSelector ) || [];
    }

    if ( validators[type] ) {
      validation.status = validators[type]( field, validation, fieldset );
    }

    return validators.empty( field, validation );
  }

  this.init = init;
  this.destroy = destroy;
  return this;
}

module.exports = FilterableListControls;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AlphaTransition.html">AlphaTransition</a></li><li><a href="BaseTransition.html">BaseTransition</a></li><li><a href="BreakpointHandler.html">BreakpointHandler</a></li><li><a href="ClearableInput.html">ClearableInput</a></li><li><a href="ContentSlider.html">ContentSlider</a></li><li><a href="EventObserver.html">EventObserver</a></li><li><a href="Expandable.html">Expandable</a></li><li><a href="ExpandableGroup.html">ExpandableGroup</a></li><li><a href="ExternalSite.html">ExternalSite</a></li><li><a href="FilterableListControls.html">FilterableListControls</a></li><li><a href="FlyoutMenu.html">FlyoutMenu</a></li><li><a href="Footer.html">Footer</a></li><li><a href="GlobalBanner.html">GlobalBanner</a></li><li><a href="GlobalSearch.html">GlobalSearch</a></li><li><a href="Header.html">Header</a></li><li><a href="MegaMenu.html">MegaMenu</a></li><li><a href="MegaMenuDesktop.html">MegaMenuDesktop</a></li><li><a href="MegaMenuMobile.html">MegaMenuMobile</a></li><li><a href="MobileCarousel.html">MobileCarousel</a></li><li><a href="MoveTransition.html">MoveTransition</a></li><li><a href="Multiselect.html">Multiselect</a></li><li><a href="Notification.html">Notification</a></li><li><a href="SecondaryNavigation.html">SecondaryNavigation</a></li><li><a href="Tree.html">Tree</a></li><li><a href="TreeNode.html">TreeNode</a></li><li><a href="UStreamPlayer.html">UStreamPlayer</a></li><li><a href="VideoPlayer.html">VideoPlayer</a></li><li><a href="YoutubePlayer.html">YoutubePlayer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_attachIFrame">_attachIFrame</a></li><li><a href="global.html#_calculateCollapseDuration">_calculateCollapseDuration</a></li><li><a href="global.html#_calculateExpandDuration">_calculateExpandDuration</a></li><li><a href="global.html#_checkableInput">_checkableInput</a></li><li><a href="global.html#_clearError">_clearError</a></li><li><a href="global.html#_constrainValue">_constrainValue</a></li><li><a href="global.html#_createElement">_createElement</a></li><li><a href="global.html#_createMessage">_createMessage</a></li><li><a href="global.html#_ensureElement">_ensureElement</a></li><li><a href="global.html#_findElements">_findElements</a></li><li><a href="global.html#_getMatchesMethod">_getMatchesMethod</a></li><li><a href="global.html#_getStorageType">_getStorageType</a></li><li><a href="global.html#_getTransitionEndEvent">_getTransitionEndEvent</a></li><li><a href="global.html#_getTransitionPrefix">_getTransitionPrefix</a></li><li><a href="global.html#_inBreakpointRange">_inBreakpointRange</a></li><li><a href="global.html#_init">_init</a></li><li><a href="global.html#_initEvents">_initEvents</a></li><li><a href="global.html#_isPlainObject">_isPlainObject</a></li><li><a href="global.html#_navSecondaryToggle">_navSecondaryToggle</a></li><li><a href="global.html#_navSecondaryToggleTest">_navSecondaryToggleTest</a></li><li><a href="global.html#_onAction">_onAction</a></li><li><a href="global.html#_scrollToTop">_scrollToTop</a></li><li><a href="global.html#_sendError">_sendError</a></li><li><a href="global.html#_sendSubscriptionRequest">_sendSubscriptionRequest</a></li><li><a href="global.html#_setChildElements">_setChildElements</a></li><li><a href="global.html#_tableClicked">_tableClicked</a></li><li><a href="global.html#_toCamelCase">_toCamelCase</a></li><li><a href="global.html#_verifyClassExists">_verifyClassExists</a></li><li><a href="global.html#_verifyElementExists">_verifyElementExists</a></li><li><a href="global.html#add">add</a></li><li><a href="global.html#assign">assign</a></li><li><a href="global.html#attach">attach</a></li><li><a href="global.html#backtrack">backtrack</a></li><li><a href="global.html#BEHAVIOR_PREFIX">BEHAVIOR_PREFIX</a></li><li><a href="global.html#bfs">bfs</a></li><li><a href="global.html#bindEvent">bindEvent</a></li><li><a href="global.html#checkBehaviorDom">checkBehaviorDom</a></li><li><a href="global.html#checkbox">checkbox</a></li><li><a href="global.html#checkDom">checkDom</a></li><li><a href="global.html#closest">closest</a></li><li><a href="global.html#contains">contains</a></li><li><a href="global.html#create">create</a></li><li><a href="global.html#dataSet">dataSet</a></li><li><a href="global.html#date">date</a></li><li><a href="global.html#destroyInitFlag">destroyInitFlag</a></li><li><a href="global.html#dfs">dfs</a></li><li><a href="global.html#email">email</a></li><li><a href="global.html#empty">empty</a></li><li><a href="global.html#find">find</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getItem">getItem</a></li><li><a href="global.html#getSiblings">getSiblings</a></li><li><a href="global.html#getViewportDimensions">getViewportDimensions</a></li><li><a href="global.html#handleViewportChange">handleViewportChange</a></li><li><a href="global.html#indexOfObject">indexOfObject</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#INIT_FLAG">INIT_FLAG</a></li><li><a href="global.html#instantiateAll">instantiateAll</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isDate">isDate</a></li><li><a href="global.html#isDefined">isDefined</a></li><li><a href="global.html#isEmpty">isEmpty</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isInDesktop">isInDesktop</a></li><li><a href="global.html#isNumber">isNumber</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#isOneExpanded">isOneExpanded</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#isThisExpanded">isThisExpanded</a></li><li><a href="global.html#isUndefined">isUndefined</a></li><li><a href="global.html#JS_HOOK">JS_HOOK</a></li><li><a href="global.html#loadScript">loadScript</a></li><li><a href="global.html#noopFunct">noopFunct</a></li><li><a href="global.html#not">not</a></li><li><a href="global.html#queryOne">queryOne</a></li><li><a href="global.html#radio">radio</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#removeItem">removeItem</a></li><li><a href="global.html#sendEvent">sendEvent</a></li><li><a href="global.html#sendEvents">sendEvents</a></li><li><a href="global.html#setInitFlag">setInitFlag</a></li><li><a href="global.html#setItem">setItem</a></li><li><a href="global.html#setStorage">setStorage</a></li><li><a href="global.html#STATE_PREFIX">STATE_PREFIX</a></li><li><a href="global.html#stringEscape">stringEscape</a></li><li><a href="global.html#stringMatch">stringMatch</a></li><li><a href="global.html#stringValid">stringValid</a></li><li><a href="global.html#testBreakpoint">testBreakpoint</a></li><li><a href="global.html#toggleExpandedState">toggleExpandedState</a></li><li><a href="global.html#watchWindowResize">watchWindowResize</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a> on Wed Nov 02 2016 08:33:37 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
