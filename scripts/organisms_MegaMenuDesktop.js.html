<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: organisms/MegaMenuDesktop.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: organisms/MegaMenuDesktop.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

// Required modules.
var EventObserver = require( '../modules/util/EventObserver' );
var fnBind = require( '../modules/util/fn-bind' ).fnBind;
var MoveTransition = require( '../modules/transition/MoveTransition' );
var treeTraversal = require( '../modules/util/tree-traversal' );

/**
 * MegaMenuDesktop
 * @class
 *
 * @classdesc Behavior for the mega menu at desktop sizes.
 *
 * @param {Tree} menus - Tree of FlyoutMenus.
 * @returns {MegaMenuDesktop} An instance.
 */
function MegaMenuDesktop( menus ) {

  // DOM references.
  var _bodyDom = document.body;
  var _firstLevelDom;

  // Binded functions.
  var _handleTriggerClickBinded = fnBind( _handleTriggerClick, this );
  var _handleTriggerOverBinded = fnBind( _handleTriggerOver, this );
  var _handleTriggerOutBinded = fnBind( _handleTriggerOut, this );
  var _handleExpandBeginBinded = fnBind( _handleExpandBegin, this );
  var _handleCollapseEndBinded = fnBind( _handleCollapseEnd, this );

  // Tree model.
  var _menus = menus;

  //  Currently showing menu picked from the tree.
  var _activeMenu = null;

  // Whether this instance's behaviors are suspended or not.
  var _suspended = true;

  // Timeout for delayed events.
  var _showDelay;

  /**
   * @returns {MegaMenuDesktop} An instance.
   */
  function init() {
    // Get the immediate parent of the 1st level menu links.
    // We'll use this later to check if we're still over the links,
    // on mouse move.
    var firstLevelMenus = _menus.getAllAtLevel( 1 );
    _firstLevelDom = firstLevelMenus[0].data.getDom().container.parentNode;

    return this;
  }

  /**
   * Pass an event bubbled up from the menus to the appropriate handler.
   * @param {Event} event - A FlyoutMenu event.
   */
  function handleEvent( event ) {
    if ( _suspended ) { return; }
    var eventMap = {
      triggerClick: _handleTriggerClickBinded,
      triggerOver:  _handleTriggerOverBinded,
      triggerOut:   _handleTriggerOutBinded,
      expandBegin:  _handleExpandBeginBinded,
      collapseEnd:  _handleCollapseEndBinded
    };

    var currHandler = eventMap[event.type];
    if ( currHandler ) {
      var delay = _calcEventDelay( event.type );
      if ( delay > 0 ) {
        _delayedEvent( currHandler, event, delay );
      } else {
        currHandler( event );
      }
    }
  }

  /**
   * @param {string} type - The type of event to check.
   * @returns {number} The amount to delay in milliseconds,
   *   length is determined based on the event type and
   *   whether the menu is active or not.
   */
  function _calcEventDelay( type ) {
    var delay = 0;
    if ( type === 'triggerClick' ) {
      window.clearTimeout( _showDelay );
    } else if ( type === 'triggerOver' ) {
      if ( _activeMenu === null ) {
        delay = 150;
      } else {
        delay = 50;
      }
    }

    return delay;
  }

  /**
   * Delay the broadcasting of an event by supplied delay.
   * @param {Function} currHandler - Event handler.
   * @param {Event} event - A FlyoutMenu event.
   * @param {number} delay - Delay in milliseconds.
   */
  function _delayedEvent( currHandler, event, delay ) {
    window.clearTimeout( _showDelay );
    _showDelay = window.setTimeout( function() {
      currHandler( event );
    }, delay );
  }

  /**
   * Event handler for when FlyoutMenu trigger is clicked.
   * @param {Event} event - A FlyoutMenu event.
   */
  function _handleTriggerClick( event ) {
    this.dispatchEvent( 'triggerClick', { target: this } );
    var menu = event.target;
    if ( menu.isAnimating() ) { return; }
    _updateMenuState( menu, event.type );
  }

  /**
   * Event handler for when FlyoutMenu trigger is hovered over.
   * @param {Event} event - A FlyoutMenu event.
   */
  function _handleTriggerOver( event ) {
    this.dispatchEvent( 'triggerOver', { target: this } );
    _updateMenuState( event.target, event.type );
  }

  /**
   * Event handler for when FlyoutMenu trigger is hovered out.
   */
  function _handleTriggerOut() {
    this.dispatchEvent( 'triggerOut', { target: this } );
    // Clear any queued events to show the menu.
    window.clearTimeout( _showDelay );
  }

  /**
   * Event handler for when FlyoutMenu expand transition begins.
   * Use this to perform post-expandBegin actions.
   */
  function _handleExpandBegin() {
    this.dispatchEvent( 'expandBegin', { target: this } );

    // Set keyboard focus on first menu item link.
    var activeMenuDom = _activeMenu.getDom().content;
    activeMenuDom.classList.remove( 'u-invisible' );
    // TODO: Remove or uncomment when keyboard navigation is in.
    // var firstMenuLink = activeMenuDom.querySelector( 'a' );
    // firstMenuLink.focus();
  }

  /**
   * Event handler for when FlyoutMenu collapse transition has ended.
   * Use this to perform post-collapseEnd actions.
   * @param {Event} event - A FlyoutMenu event.
   */
  function _handleCollapseEnd( event ) {
    this.dispatchEvent( 'collapseEnd', { target: this } );
    event.target.getDom().content.classList.add( 'u-invisible' );
  }

  /**
   * Event handler for when mouse is hovering.
   * @param {MouseEvent} event - The hovering event.
   */
  function _handleMove( event ) {
    // If we've left the parent container of the current menu, close it.
    if ( !_firstLevelDom.contains( event.target ) ) {
      _updateMenuState( null, event.type );
    }
  }

  /**
   * Cleanup state and set the currently active menu.
   * @param {FlyoutMenu} menu - The menu currently being activated.
   * @param {string} type - The event type that is calling this method.
   */
  function _updateMenuState( menu, type ) {
    if ( menu === null || _activeMenu === menu ) {
      // A menu is closed.
      window.clearTimeout( _showDelay );
      _activeMenu.getTransition().animateOn();
      _activeMenu.collapse();
      _activeMenu = null;
      _bodyDom.removeEventListener( 'mousemove', _handleMove );
      _bodyDom.removeEventListener( 'mouseleave', _handleMove );
    } else if ( _activeMenu === null ) {
      // A menu is opened.
      _activeMenu = menu;
      _activeMenu.getTransition().animateOn();
      // Mousemove needed in addition to mouseout of the trigger
      // in order to check if user has moved off the menu &lt;ul> and not
      // just the &lt;li> list items.
      _bodyDom.addEventListener( 'mousemove', _handleMove );
      _bodyDom.addEventListener( 'mouseleave', _handleMove );
      _activeMenu.expand();
    } else {
      // An open menu has switched to another menu.
      _activeMenu.getTransition().animateOff();
      _activeMenu.collapse();
      _activeMenu = menu;
      if ( type === 'triggerOver' ) {
        _activeMenu.getTransition().animateOff();
        _activeMenu.expand();
      }
    }
  }

  /**
   * Add events necessary for the desktop menu behaviors.
   * @returns {boolean} Whether it has successfully been resumed or not.
   */
  function resume() {
    if ( _suspended ) {
      treeTraversal.bfs( _menus.getRoot(), _handleResumeTraversal );
      _suspended = false;
    }

    return !_suspended;
  }

  /**
   * Remove events necessary for the desktop menu behaviors.
   * @returns {boolean} Whether it has successfully been suspended or not.
   */
  function suspend() {
    if ( !_suspended ) {
      treeTraversal.bfs( _menus.getRoot(), _handleSuspendTraversal );

      // Ensure body events were removed.
      _bodyDom.removeEventListener( 'mousemove', _handleMove );
      _bodyDom.removeEventListener( 'mouseleave', _handleMove );
      // Clear active menu.
      _activeMenu = null;
      _suspended = true;
    }

    return _suspended;
  }

  /**
   * Iterate over the sub menus and handle setting the resumed state.
   * @param {TreeNode} node - The data source for the current menu.
   */
  function _handleResumeTraversal( node ) {
    var nLevel = node.level;
    var menu = node.data;

    if ( nLevel === 1 ) {
      var wrapperSel = '.o-mega-menu_content-2-wrapper';
      var contentDom = menu.getDom().content;
      var wrapperDom = contentDom.querySelector( wrapperSel );
      var transition = menu.getTransition();

      // This ensures the transition has been removed by MegaMenuMobile.
      transition = _setTransitionElement( wrapperDom, transition );
      transition.moveUp();

      // TODO: The only reason hiding is necessary is that the
      //       drop-shadow of the menu extends below its border,
      //       so it's still visible when the menu slides -100% out of view.
      //       Investigate whether it would be better to have a u-move-up-1_1x
      //       or similar class to move up -110%. Or whether the drop-shadow
      //       could be included within the bounds of the menu.
      menu.getDom().content.classList.add( 'u-invisible' );
      menu.setExpandTransition( transition, transition.moveToOrigin );
      menu.setCollapseTransition( transition, transition.moveUp );

      // TODO: Investigate whether deferred collapse has another solution.
      //       This check is necessary since a call to an already collapsed
      //       menu will set a deferred collapse that will be called
      //       on expandEnd next time the flyout is expanded.
      //       The deferred collapse is used in cases where the
      //       user clicks the flyout menu while it is animating open,
      //       so that it appears like they can collapse it, even when
      //       clicking during the expand animation.
      if ( menu.isExpanded() ) {
        menu.collapse();
      }
    } else if ( nLevel === 2 ) {
      menu.suspend();
    }
  }

  /**
   * Iterate over the sub menus and handle setting the suspended state.
   * @param {TreeNode} node - The data source for the current menu.
   */
  function _handleSuspendTraversal( node ) {
    var nLevel = node.level;
    var menu = node.data;

    if ( nLevel === 1 ) {
      menu.clearTransitions();
      menu.getDom().content.classList.remove( 'u-invisible' );

      if ( menu.isExpanded() ) {
        menu.collapse();
      }
    } else if ( nLevel === 2 ) {
      menu.resume();
    }
  }

  /**
   * Set an element on an existing transition or create a new transition.
   * @param {HTMLNode} element - Target of a transition.
   * @param {MoveTransition} [setTransition] - The transition to apply.
   * @returns {MoveTransition}
   *   The passed in transition or a new transition if none was supplied.
   */
  function _setTransitionElement( element, setTransition ) {
    var transition = setTransition;
    if ( transition ) {
      transition.setElement( element );
    } else {
      transition = new MoveTransition( element ).init();
    }

    return transition;
  }

  // Attach public events.
  var eventObserver = new EventObserver();
  this.addEventListener = eventObserver.addEventListener;
  this.removeEventListener = eventObserver.removeEventListener;
  this.dispatchEvent = eventObserver.dispatchEvent;

  this.handleEvent = handleEvent;
  this.init = init;
  this.resume = resume;
  this.suspend = suspend;

  return this;
}

module.exports = MegaMenuDesktop;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AlphaTransition.html">AlphaTransition</a></li><li><a href="BaseTransition.html">BaseTransition</a></li><li><a href="BreakpointHandler.html">BreakpointHandler</a></li><li><a href="ClearableInput.html">ClearableInput</a></li><li><a href="ContentSlider.html">ContentSlider</a></li><li><a href="EventObserver.html">EventObserver</a></li><li><a href="Expandable.html">Expandable</a></li><li><a href="ExpandableGroup.html">ExpandableGroup</a></li><li><a href="ExternalSite.html">ExternalSite</a></li><li><a href="FilterableListControls.html">FilterableListControls</a></li><li><a href="FlyoutMenu.html">FlyoutMenu</a></li><li><a href="Footer.html">Footer</a></li><li><a href="GlobalBanner.html">GlobalBanner</a></li><li><a href="GlobalSearch.html">GlobalSearch</a></li><li><a href="Header.html">Header</a></li><li><a href="MegaMenu.html">MegaMenu</a></li><li><a href="MegaMenuDesktop.html">MegaMenuDesktop</a></li><li><a href="MegaMenuMobile.html">MegaMenuMobile</a></li><li><a href="MobileCarousel.html">MobileCarousel</a></li><li><a href="MoveTransition.html">MoveTransition</a></li><li><a href="Multiselect.html">Multiselect</a></li><li><a href="Notification.html">Notification</a></li><li><a href="SecondaryNavigation.html">SecondaryNavigation</a></li><li><a href="Tree.html">Tree</a></li><li><a href="TreeNode.html">TreeNode</a></li><li><a href="UStreamPlayer.html">UStreamPlayer</a></li><li><a href="VideoPlayer.html">VideoPlayer</a></li><li><a href="YoutubePlayer.html">YoutubePlayer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_attachIFrame">_attachIFrame</a></li><li><a href="global.html#_calculateCollapseDuration">_calculateCollapseDuration</a></li><li><a href="global.html#_calculateExpandDuration">_calculateExpandDuration</a></li><li><a href="global.html#_checkableInput">_checkableInput</a></li><li><a href="global.html#_clearError">_clearError</a></li><li><a href="global.html#_constrainValue">_constrainValue</a></li><li><a href="global.html#_createElement">_createElement</a></li><li><a href="global.html#_createMessage">_createMessage</a></li><li><a href="global.html#_ensureElement">_ensureElement</a></li><li><a href="global.html#_findElements">_findElements</a></li><li><a href="global.html#_getMatchesMethod">_getMatchesMethod</a></li><li><a href="global.html#_getStorageType">_getStorageType</a></li><li><a href="global.html#_getTransitionEndEvent">_getTransitionEndEvent</a></li><li><a href="global.html#_getTransitionPrefix">_getTransitionPrefix</a></li><li><a href="global.html#_inBreakpointRange">_inBreakpointRange</a></li><li><a href="global.html#_init">_init</a></li><li><a href="global.html#_initEvents">_initEvents</a></li><li><a href="global.html#_isPlainObject">_isPlainObject</a></li><li><a href="global.html#_navSecondaryToggle">_navSecondaryToggle</a></li><li><a href="global.html#_navSecondaryToggleTest">_navSecondaryToggleTest</a></li><li><a href="global.html#_onAction">_onAction</a></li><li><a href="global.html#_scrollToTop">_scrollToTop</a></li><li><a href="global.html#_sendError">_sendError</a></li><li><a href="global.html#_sendSubscriptionRequest">_sendSubscriptionRequest</a></li><li><a href="global.html#_setChildElements">_setChildElements</a></li><li><a href="global.html#_tableClicked">_tableClicked</a></li><li><a href="global.html#_toCamelCase">_toCamelCase</a></li><li><a href="global.html#_verifyClassExists">_verifyClassExists</a></li><li><a href="global.html#_verifyElementExists">_verifyElementExists</a></li><li><a href="global.html#add">add</a></li><li><a href="global.html#assign">assign</a></li><li><a href="global.html#attach">attach</a></li><li><a href="global.html#backtrack">backtrack</a></li><li><a href="global.html#BEHAVIOR_PREFIX">BEHAVIOR_PREFIX</a></li><li><a href="global.html#bfs">bfs</a></li><li><a href="global.html#bindEvent">bindEvent</a></li><li><a href="global.html#checkBehaviorDom">checkBehaviorDom</a></li><li><a href="global.html#checkbox">checkbox</a></li><li><a href="global.html#checkDom">checkDom</a></li><li><a href="global.html#closest">closest</a></li><li><a href="global.html#contains">contains</a></li><li><a href="global.html#create">create</a></li><li><a href="global.html#dataSet">dataSet</a></li><li><a href="global.html#date">date</a></li><li><a href="global.html#destroyInitFlag">destroyInitFlag</a></li><li><a href="global.html#dfs">dfs</a></li><li><a href="global.html#email">email</a></li><li><a href="global.html#empty">empty</a></li><li><a href="global.html#find">find</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getItem">getItem</a></li><li><a href="global.html#getSiblings">getSiblings</a></li><li><a href="global.html#getViewportDimensions">getViewportDimensions</a></li><li><a href="global.html#handleViewportChange">handleViewportChange</a></li><li><a href="global.html#indexOfObject">indexOfObject</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#INIT_FLAG">INIT_FLAG</a></li><li><a href="global.html#instantiateAll">instantiateAll</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isDate">isDate</a></li><li><a href="global.html#isDefined">isDefined</a></li><li><a href="global.html#isEmpty">isEmpty</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isInDesktop">isInDesktop</a></li><li><a href="global.html#isNumber">isNumber</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#isOneExpanded">isOneExpanded</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#isThisExpanded">isThisExpanded</a></li><li><a href="global.html#isUndefined">isUndefined</a></li><li><a href="global.html#JS_HOOK">JS_HOOK</a></li><li><a href="global.html#loadScript">loadScript</a></li><li><a href="global.html#noopFunct">noopFunct</a></li><li><a href="global.html#not">not</a></li><li><a href="global.html#queryOne">queryOne</a></li><li><a href="global.html#radio">radio</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#removeItem">removeItem</a></li><li><a href="global.html#sendEvent">sendEvent</a></li><li><a href="global.html#sendEvents">sendEvents</a></li><li><a href="global.html#setInitFlag">setInitFlag</a></li><li><a href="global.html#setItem">setItem</a></li><li><a href="global.html#setStorage">setStorage</a></li><li><a href="global.html#STATE_PREFIX">STATE_PREFIX</a></li><li><a href="global.html#stringEscape">stringEscape</a></li><li><a href="global.html#stringMatch">stringMatch</a></li><li><a href="global.html#stringValid">stringValid</a></li><li><a href="global.html#testBreakpoint">testBreakpoint</a></li><li><a href="global.html#toggleExpandedState">toggleExpandedState</a></li><li><a href="global.html#watchWindowResize">watchWindowResize</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a> on Wed Nov 02 2016 08:33:37 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
